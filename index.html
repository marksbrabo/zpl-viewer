<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZPL Viewer &mdash; Visualizador de Etiquetas Shopee</title>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242734;--border:#2e3144;
  --text:#e4e4e7;--text2:#a0a0ab;--accent:#3b82f6;--accent-hover:#2563eb;
  --success:#22c55e;--danger:#ef4444;
}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* Header */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;gap:16px;flex-shrink:0}
header h1{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
header h1 span{color:var(--accent)}
.header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--border);border-color:#3e4256}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-hover)}
.btn-success{background:var(--success);border-color:var(--success);color:#fff}
.btn-success:hover{background:#16a34a}
.btn-danger{background:transparent;border-color:var(--danger);color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:#fff}
.btn-sm{padding:5px 10px;font-size:12px}

/* Main Layout */
main{flex:1;display:flex;overflow:hidden}

/* Editor Panel */
.editor-panel{width:50%;display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:300px}
.panel-header{padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.panel-header h2{font-size:14px;font-weight:600;color:var(--text2)}
.panel-header .badge{background:var(--accent);color:#fff;font-size:11px;padding:2px 8px;border-radius:12px;font-weight:600}
.editor-area{flex:1;position:relative}
.editor-area textarea{width:100%;height:100%;background:var(--bg);color:#c5c8d4;border:none;padding:16px;font-family:'Cascadia Code','Fira Code','JetBrains Mono',monospace;font-size:13px;line-height:1.6;resize:none;outline:none;tab-size:4}
.editor-area textarea::placeholder{color:#4a4d5e}
.editor-footer{padding:8px 16px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;font-size:12px;color:var(--text2)}

/* Preview Panel */
.preview-panel{flex:1;display:flex;flex-direction:column;min-width:300px}
.preview-controls{padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;flex-shrink:0}
.control-group{display:flex;align-items:center;gap:6px}
.control-group label{font-size:12px;color:var(--text2);white-space:nowrap}
.control-group select,.control-group input[type=number]{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:6px;font-size:12px;outline:none}
.control-group select:focus,.control-group input:focus{border-color:var(--accent)}
.control-group input[type=number]{width:60px}
.preview-area{flex:1;overflow:auto;padding:24px;background:var(--bg);display:flex;flex-wrap:wrap;gap:16px;align-content:flex-start;justify-content:center}
.label-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;transition:box-shadow .2s}
.label-card:hover{box-shadow:0 4px 20px rgba(59,130,246,.15)}
.label-card .card-header{padding:6px 12px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px;color:var(--text2);display:flex;justify-content:space-between;align-items:center}
.label-card canvas{display:block}

/* Drop Zone */
.drop-zone{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:rgba(15,17,23,.92);border:2px dashed var(--accent);border-radius:12px;margin:12px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:10}
.drop-zone.active{opacity:1;pointer-events:all}
.drop-zone svg{width:48px;height:48px;color:var(--accent)}
.drop-zone p{font-size:15px;color:var(--text2)}
.drop-zone p strong{color:var(--text)}

/* Empty State */
.empty-state{text-align:center;padding:60px 24px;color:var(--text2)}
.empty-state svg{width:64px;height:64px;margin-bottom:16px;color:var(--border)}
.empty-state h3{font-size:16px;color:var(--text);margin-bottom:8px}
.empty-state p{font-size:13px;line-height:1.6}

/* Resizer */
.resizer{width:4px;cursor:col-resize;background:transparent;transition:background .2s;flex-shrink:0}
.resizer:hover,.resizer.dragging{background:var(--accent)}

/* Responsive */
@media(max-width:768px){
  main{flex-direction:column}
  .editor-panel{width:100%;height:40%;border-right:none;border-bottom:1px solid var(--border);min-width:unset}
  .preview-panel{min-width:unset}
  .resizer{display:none}
}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 20px;font-size:13px;color:var(--text);box-shadow:0 8px 30px rgba(0,0,0,.4);transform:translateY(100px);opacity:0;transition:all .3s;z-index:100}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--success)}
.toast.error{border-color:var(--danger)}

/* Zoom indicator */
.zoom-indicator{font-size:11px;color:var(--accent);font-weight:600}
</style>
</head>
<body>

<header>
  <h1>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h3v3H7zM14 7h3v3h-3zM7 14h3v3H7zM14 14h3v3h-3z"/></svg>
    <span>ZPL</span> Viewer
  </h1>
  <span style="font-size:12px;color:var(--text2)">Visualizador de Etiquetas Shopee</span>
  <div class="header-actions">
    <button class="btn btn-sm" id="btnLoad" title="Carregar arquivo">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Carregar
    </button>
    <button class="btn btn-sm btn-primary" id="btnRender" title="Ctrl+Enter">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      Renderizar
    </button>
    <button class="btn btn-sm btn-danger" id="btnClear" title="Limpar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      Limpar
    </button>
  </div>
</header>

<main>
  <div class="editor-panel" id="editorPanel">
    <div class="panel-header">
      <h2>Codigo ZPL</h2>
      <span class="badge" id="labelCount">0 etiquetas</span>
    </div>
    <div class="editor-area" id="editorArea">
      <div class="drop-zone" id="dropZone">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p>Solte o arquivo <strong>.txt / .zpl</strong> aqui</p>
      </div>
      <textarea id="zplInput" placeholder="Cole o codigo ZPL aqui ou arraste um arquivo .txt / .zpl ..." spellcheck="false"></textarea>
    </div>
    <div class="editor-footer">
      <span id="charCount">0 caracteres</span>
      <span style="margin-left:auto">Ctrl+Enter para renderizar</span>
    </div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="preview-panel">
    <div class="preview-controls">
      <div class="control-group">
        <label>Densidade:</label>
        <select id="dpmm">
          <option value="6">6 dpmm (152 dpi)</option>
          <option value="8" selected>8 dpmm (203 dpi)</option>
          <option value="12">12 dpmm (300 dpi)</option>
          <option value="24">24 dpmm (600 dpi)</option>
        </select>
      </div>
      <div class="control-group">
        <label>Zoom:</label>
        <input type="range" id="zoomRange" min="25" max="400" value="100" style="width:100px;accent-color:var(--accent)">
        <span class="zoom-indicator" id="zoomLabel">100%</span>
      </div>
      <div class="control-group">
        <label>Fundo:</label>
        <select id="bgColor">
          <option value="#ffffff">Branco</option>
          <option value="#f5f5dc">Bege</option>
          <option value="#fffdd0">Creme</option>
        </select>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn btn-sm" id="btnExportPng">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          PNG
        </button>
        <button class="btn btn-sm" id="btnExportPdf">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          PDF
        </button>
      </div>
    </div>
    <div class="preview-area" id="previewArea">
      <div class="empty-state" id="emptyState">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h3v3H7zM14 7h3v3h-3zM7 14h3v3H7z"/></svg>
        <h3>Nenhuma etiqueta renderizada</h3>
        <p>Cole o codigo ZPL no editor ao lado e clique em <strong>Renderizar</strong>,<br>ou arraste um arquivo diretamente no editor.</p>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".txt,.zpl,.prn" hidden>

<script>
// ──────────── Elements ────────────
const zplInput    = document.getElementById('zplInput');
const previewArea = document.getElementById('previewArea');
const emptyState  = document.getElementById('emptyState');
const labelCount  = document.getElementById('labelCount');
const charCount   = document.getElementById('charCount');
const btnRender   = document.getElementById('btnRender');
const btnClear    = document.getElementById('btnClear');
const btnLoad     = document.getElementById('btnLoad');
const btnPng      = document.getElementById('btnExportPng');
const btnPdf      = document.getElementById('btnExportPdf');
const fileInput   = document.getElementById('fileInput');
const dropZone    = document.getElementById('dropZone');
const editorArea  = document.getElementById('editorArea');
const zoomRange   = document.getElementById('zoomRange');
const zoomLabel   = document.getElementById('zoomLabel');
const bgColor     = document.getElementById('bgColor');
const toastEl     = document.getElementById('toast');
const resizer     = document.getElementById('resizer');
const editorPanel = document.getElementById('editorPanel');

let renderedLabels = []; // {canvas, width, height, index}

// ──────────── Toast ────────────
function toast(msg, type='success') {
  toastEl.textContent = msg;
  toastEl.className = 'toast show ' + type;
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(() => toastEl.className = 'toast', 3000);
}

// ──────────── Char count ────────────
zplInput.addEventListener('input', () => {
  charCount.textContent = zplInput.value.length.toLocaleString('pt-BR') + ' caracteres';
});

// ──────────── File load ────────────
btnLoad.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  readFile(f);
  fileInput.value = '';
});

function readFile(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    zplInput.value = ev.target.result;
    zplInput.dispatchEvent(new Event('input'));
    toast('Arquivo carregado: ' + file.name);
  };
  reader.readAsText(file);
}

// ──────────── Drag & Drop ────────────
['dragenter','dragover'].forEach(ev =>
  editorArea.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('active'); })
);
['dragleave','drop'].forEach(ev =>
  editorArea.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('active'); })
);
editorArea.addEventListener('drop', e => {
  const f = e.dataTransfer.files[0];
  if (f) readFile(f);
});

// ──────────── Resizer ────────────
let isResizing = false;
resizer.addEventListener('mousedown', e => {
  isResizing = true;
  resizer.classList.add('dragging');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});
document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  const pct = (e.clientX / window.innerWidth) * 100;
  if (pct > 20 && pct < 80) editorPanel.style.width = pct + '%';
});
document.addEventListener('mouseup', () => {
  if (isResizing) {
    isResizing = false;
    resizer.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }
});

// ──────────── Keyboard shortcuts ────────────
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    renderZPL();
  }
});

// ──────────── Render Button ────────────
btnRender.addEventListener('click', renderZPL);

// ──────────── Clear ────────────
btnClear.addEventListener('click', () => {
  zplInput.value = '';
  zplInput.dispatchEvent(new Event('input'));
  previewArea.innerHTML = '';
  previewArea.appendChild(emptyState);
  emptyState.style.display = '';
  renderedLabels = [];
  labelCount.textContent = '0 etiquetas';
});

// ──────────── Zoom ────────────
zoomRange.addEventListener('input', () => {
  const z = zoomRange.value;
  zoomLabel.textContent = z + '%';
  applyZoom();
});

function applyZoom() {
  const scale = zoomRange.value / 100;
  document.querySelectorAll('.label-card canvas').forEach(c => {
    c.style.width = (c._origW * scale) + 'px';
    c.style.height = (c._origH * scale) + 'px';
  });
}

// ──────────── Background color ────────────
bgColor.addEventListener('change', () => {
  if (renderedLabels.length) renderZPL();
});

// ══════════════════════════════════════════════
//  ZPL PARSING + RENDERING
// ══════════════════════════════════════════════

function renderZPL() {
  const raw = zplInput.value.trim();
  if (!raw) { toast('Cole o codigo ZPL primeiro', 'error'); return; }

  const labels = parseZPL(raw);
  if (!labels.length) { toast('Nenhuma etiqueta encontrada no ZPL', 'error'); return; }

  renderedLabels = [];
  previewArea.innerHTML = '';
  emptyState.style.display = 'none';

  labels.forEach((lbl, i) => {
    const card = document.createElement('div');
    card.className = 'label-card';

    const hdr = document.createElement('div');
    hdr.className = 'card-header';
    hdr.innerHTML = `<span>Etiqueta ${i + 1}</span><span>${lbl.width}×${lbl.height}px</span>`;
    card.appendChild(hdr);

    const canvas = document.createElement('canvas');
    canvas.width = lbl.width;
    canvas.height = lbl.height;
    canvas._origW = lbl.width;
    canvas._origH = lbl.height;

    const ctx = canvas.getContext('2d');
    const bg = bgColor.value;
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, lbl.width, lbl.height);

    const imgData = ctx.createImageData(lbl.width, lbl.height);
    const pixels = imgData.data;

    for (let row = 0; row < lbl.height; row++) {
      for (let col = 0; col < lbl.width; col++) {
        const byteIdx = row * lbl.bytesPerRow + Math.floor(col / 8);
        const bitIdx = 7 - (col % 8);
        const bit = (lbl.bitmap[byteIdx] >> bitIdx) & 1;
        const px = (row * lbl.width + col) * 4;
        if (bit) {
          // bit=1 means black dot
          pixels[px]     = 0;
          pixels[px + 1] = 0;
          pixels[px + 2] = 0;
          pixels[px + 3] = 255;
        } else {
          // background
          const r = parseInt(bg.slice(1,3),16);
          const g = parseInt(bg.slice(3,5),16);
          const b = parseInt(bg.slice(5,7),16);
          pixels[px]     = r;
          pixels[px + 1] = g;
          pixels[px + 2] = b;
          pixels[px + 3] = 255;
        }
      }
    }

    ctx.putImageData(imgData, 0, 0);
    card.appendChild(canvas);
    previewArea.appendChild(card);
    renderedLabels.push({ canvas, width: lbl.width, height: lbl.height, index: i });
  });

  labelCount.textContent = labels.length + ' etiqueta' + (labels.length > 1 ? 's' : '');
  applyZoom();
  toast(labels.length + ' etiqueta(s) renderizada(s)');
}

function parseZPL(raw) {
  const labels = [];
  // Match ~DG commands with Z64 data
  const dgRegex = /~DG\S*,(\d+),(\d+),\s*:Z64:([\s\S]*?)(?::[\dA-Fa-f]{4})/g;
  let match;

  while ((match = dgRegex.exec(raw)) !== null) {
    const totalBytes = parseInt(match[1]);
    const bytesPerRow = parseInt(match[2]);
    const z64data = match[3].replace(/[\s\r\n]/g, '');

    try {
      const binaryStr = atob(z64data);
      const compressed = new Uint8Array(binaryStr.length);
      for (let i = 0; i < binaryStr.length; i++) {
        compressed[i] = binaryStr.charCodeAt(i);
      }
      const bitmap = pako.inflate(compressed);

      const width = bytesPerRow * 8;
      const height = Math.floor(bitmap.length / bytesPerRow);

      if (width > 0 && height > 0) {
        labels.push({ bitmap, width, height, bytesPerRow, totalBytes });
      }
    } catch (err) {
      console.warn('Erro ao decodificar Z64:', err);
    }
  }

  // Also try B64 encoding
  const b64Regex = /~DG\S*,(\d+),(\d+),\s*:B64:([\s\S]*?)(?::[\dA-Fa-f]{4})/g;
  while ((match = b64Regex.exec(raw)) !== null) {
    const totalBytes = parseInt(match[1]);
    const bytesPerRow = parseInt(match[2]);
    const b64data = match[3].replace(/[\s\r\n]/g, '');

    try {
      const binaryStr = atob(b64data);
      const bitmap = new Uint8Array(binaryStr.length);
      for (let i = 0; i < binaryStr.length; i++) {
        bitmap[i] = binaryStr.charCodeAt(i);
      }

      const width = bytesPerRow * 8;
      const height = Math.floor(bitmap.length / bytesPerRow);

      if (width > 0 && height > 0) {
        labels.push({ bitmap, width, height, bytesPerRow, totalBytes });
      }
    } catch (err) {
      console.warn('Erro ao decodificar B64:', err);
    }
  }

  // Also try raw hex ~DG (no :Z64: or :B64: prefix)
  const hexRegex = /~DG\S*,(\d+),(\d+),((?:[0-9A-Fa-f]{2,}[\r\n]*)+)/g;
  while ((match = hexRegex.exec(raw)) !== null) {
    const totalBytes = parseInt(match[1]);
    const bytesPerRow = parseInt(match[2]);
    const hexData = match[3].replace(/[\s\r\n]/g, '');

    // Skip if it starts with :Z64: or :B64:
    if (hexData.startsWith(':')) continue;

    try {
      const bitmap = new Uint8Array(hexData.length / 2);
      for (let i = 0; i < hexData.length; i += 2) {
        bitmap[i / 2] = parseInt(hexData.substr(i, 2), 16);
      }

      const width = bytesPerRow * 8;
      const height = Math.floor(bitmap.length / bytesPerRow);

      if (width > 0 && height > 0) {
        labels.push({ bitmap, width, height, bytesPerRow, totalBytes });
      }
    } catch (err) {
      console.warn('Erro ao decodificar hex:', err);
    }
  }

  return labels;
}

// ──────────── Export PNG ────────────
btnPng.addEventListener('click', () => {
  if (!renderedLabels.length) { toast('Renderize primeiro', 'error'); return; }
  renderedLabels.forEach((lbl, i) => {
    const link = document.createElement('a');
    link.download = `etiqueta_${i + 1}.png`;
    link.href = lbl.canvas.toDataURL('image/png');
    link.click();
  });
  toast(renderedLabels.length + ' PNG(s) exportado(s)');
});

// ──────────── Export PDF ────────────
btnPdf.addEventListener('click', () => {
  if (!renderedLabels.length) { toast('Renderize primeiro', 'error'); return; }

  const { jsPDF } = window.jspdf;
  const dpmm = parseInt(document.getElementById('dpmm').value);

  // Calculate page size from first label
  const first = renderedLabels[0];
  const wMM = first.width / dpmm;
  const hMM = first.height / dpmm;

  const doc = new jsPDF({ orientation: wMM > hMM ? 'l' : 'p', unit: 'mm', format: [wMM, hMM] });

  renderedLabels.forEach((lbl, i) => {
    if (i > 0) doc.addPage([wMM, hMM]);
    const imgData = lbl.canvas.toDataURL('image/png');
    doc.addImage(imgData, 'PNG', 0, 0, wMM, hMM);
  });

  doc.save('etiquetas_shopee.pdf');
  toast('PDF exportado');
});
</script>
</body>
</html>
